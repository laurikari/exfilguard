name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_release:
        description: 'Publish GitHub Release (true) or skip (false)'
        required: false
        default: 'false'
      publish_pages:
        description: 'Publish GitHub Pages site (true) or skip (false)'
        required: false
        default: 'false'

permissions:
  contents: write
  pages: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PUBLISH_RELEASE: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || inputs.publish_release == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build release binary
        run: cargo build --release

      - name: Build .deb package
        run: cargo deb

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: target/debian/*.deb

      - name: Create GitHub Release
        if: env.PUBLISH_RELEASE == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: target/debian/*.deb
          generate_release_notes: true

  publish-apt:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || inputs.publish_pages == 'true'
    env:
      PUBLISH_PAGES: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || inputs.publish_pages == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install MkDocs Material
        run: pip install mkdocs-material

      - name: Build documentation
        run: mkdocs build

      - name: Install dpkg-scanpackages
        if: env.PUBLISH_PAGES == 'true'
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev

      - name: Download .deb artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-package
          path: deb-package

      - name: Prepare GitHub Pages content
        run: |
          # MkDocs outputs to site/ directory
          mkdir -p site/apt

          # Copy .deb package to apt directory
          cp deb-package/*.deb site/apt/

          # Generate APT repository metadata
          cd site/apt
          dpkg-scanpackages --multiversion . /dev/null > Packages
          gzip -k -f Packages

          # Generate Release file with proper Date and Hash entries
          cat > Release <<EOF
          Origin: ExfilGuard
          Label: ExfilGuard
          Suite: stable
          Codename: stable
          Architectures: amd64
          Components: main
          Description: ExfilGuard APT repository
          Date: $(date -Ru)
          EOF
          # Remove leading whitespace from Release file
          sed -i 's/^[[:space:]]*//' Release

          # Add hash entries for Packages files
          {
            echo "MD5Sum:"
            for f in Packages Packages.gz; do
              hash=$(md5sum "$f" | cut -d' ' -f1)
              size=$(wc -c < "$f" | tr -d ' ')
              echo " $hash $size $f"
            done
            echo "SHA256:"
            for f in Packages Packages.gz; do
              hash=$(sha256sum "$f" | cut -d' ' -f1)
              size=$(wc -c < "$f" | tr -d ' ')
              echo " $hash $size $f"
            done
          } >> Release

      - name: Deploy to GitHub Pages
        if: env.PUBLISH_PAGES == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          force_orphan: true
